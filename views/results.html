<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Results</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <style>
#chart-container {
    width: 400px;
    margin: 0 auto;
}

.bar-chart {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 5px;
}

.bar {
    display: contents;
}

.bar-label {
    text-align: right;
    padding-right: 10px;
    font-size: 1.5em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bar-value {
    background-color: #4CAF50;
    height: 40px;
    transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
    border-radius: 5px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.9); }
    to { transform: scale(1); }
}

#wordcloud li {
    animation: fadeIn 0.5s ease-out, scaleIn 0.5s ease-out;
}

.bar-value.updated {
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

    </style>
</head>
<body>
    {{if ne .Slide.ResultType "wordcloud"}}
    <h1>{{.Slide.Question}}</h1>
    {{end}}
    <div id="results-container">
        {{if eq .Slide.ResultType "wordcloud"}}
            {{template "wordcloud" .}}
        {{else if eq .Slide.ResultType "bar"}}
        <div id="chart-container" class="bar-chart"></div>
        {{end}}
        <ul id="results-list" style="display: none;">
            {{range $answer, $count := .Results}}
                <li data-answer="{{$answer}}">{{$answer}}: <span class="count">{{$count}}</span></li>
            {{end}}
        </ul>
    </div>

    <div class="bottom-icons">
        <div class="user-info">
            <span class="user-icon">ðŸ‘¤</span>
            <span id="user-count">0</span>
        </div>
        <button id="emoji-button" class="emoji-button">ðŸŽ‰</button>
    </div>

    <script src="/static/js/app.js"></script>

    <script>
    function updateBarChart() {
        const container = document.getElementById('chart-container');
        if (!container) return;

        const results = window.appState.results;
        const maxValue = Math.max(...Object.values(results));

        Object.entries(results).forEach(([answer, count]) => {
            let bar = container.querySelector(`.bar[data-answer="${answer}"]`);
            const width = (count / maxValue) * 100;

            if (bar) {
                const value = bar.querySelector('.bar-value');
                value.style.width = `${width}%`;
                value.classList.add('updated');
                setTimeout(() => value.classList.remove('updated'), 500);
            } else {
                bar = document.createElement('div');
                bar.className = 'bar';
                bar.setAttribute('data-answer', answer);

                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = answer;

                const value = document.createElement('div');
                value.className = 'bar-value';
                value.style.width = `${width}%`;

                bar.appendChild(label);
                bar.appendChild(value);
                container.appendChild(bar);
            }
        });

        // Remove bars for answers that no longer exist
        container.querySelectorAll('.bar').forEach(bar => {
            const answer = bar.getAttribute('data-answer');
            if (!(answer in results)) {
                bar.remove();
            }
        });
    }

    function getColor(index) {
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
        return colors[index % colors.length];
    }

    window.appState.subscribe((key, value) => {
        if (key === 'results') {
            updateBarChart();
        }
    });

    addEventListener("DOMContentLoaded", (event) => {
        window.appState.enableEmojis = true;
        const resultsList = document.getElementById('results-list');
        if (resultsList) {
            const initialResults = {};
            const listItems = resultsList.querySelectorAll('li');
            listItems.forEach(li => {
                const answer = li.getAttribute('data-answer');
                const count = parseInt(li.querySelector('.count').textContent);
                initialResults[answer] = count;
            });

            window.appState.results = initialResults;

            updateBarChart();
        }
    });
    </script>
</body>
</html>